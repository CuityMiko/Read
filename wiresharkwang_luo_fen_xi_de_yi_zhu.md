# Wireshark网络分析的艺术

## 1. 读者问

### 像福尔摩斯一样思考

![](QQ20160929-1.png)

点击每一个包都会显示这些属性

1. Identification 如果第一次发过来0,以后一般都是0
2. TTL默认开始是64,而中间经过了多少代理就会-1



### 来点有深度的

延迟确认发生太多会影响性能

可通过`tcp.analysis.ack_rtt > 0.2 and tcp.len ==0`来显示出有可能延迟确认带来的包

![小米](QQ20160929-0.png)


这里我自己连接小米路由器的TCP,有非常多的小米延迟连接,所以我时候也会卡之类d的

### 三次握手的小知识

客户端->SYN seq=X ->服务器

客户端<-SYN seq=Y,Ack=X+1<-服务器

客户端->Seq=X+1 ACK=Y+1->服务器

![tcp](QQ20160930-0.png)

这个是我打开一个网页.然后捕抓src和dst为访问网页的IP

然后前3个就是3次握手

可以看看 Seq和ACK值的变化和我刚的描述变化是一样的

当然这个数字太长,可以默认初始值都为0

`Perferences->Protocols->TCP->勾选Relative Sequence Numbers`

这样设置后,成功的握手都是一样的,但是失败的握手就不一样了

失败握手一般分为两种情况

1. 被拒绝
2. 丢包

一般获取失败握手的表达式可以设置为

`(tcp.flags.reset==1) && (tcp.seq ==1)`

或者

过滤重传的握手请求: `(tcp.flags.syn == 1) && (tcp.analysis.retransmission)`

找到了之后,右键追踪TCP流

这是我的一个被拒绝得TCP流

![被拒绝的tcp](QQ20161008-0.png)

但是这样没办法判断丢包是

1. 没传到服务器就丢了
2. 还是服务器接受到了,但是回传的时候丢了

所以最好在客户端和服务器同时抓包

说说DDoS

原理就是大量主机发送SYN请求给服务器,假装建立TCP,这些SYN请求可能包含假的源地址,所以服务器永远收不到Ack,就会留下half-open的连接,每个TCP占用一定的系统资源,建立多了服务器资源就会被耗光

### 被误解的TCP

TCP并非每一个数据包都有对应的Ack

因为延迟确认可以多个包对应一个Ack

TCP VS UDP

误解是

TCP效率低因为要往返确认Ack

而UDP无需确认,就效率高

但是这是区分场景的

在传送大包时,只要窗口足够大,整个通道充满着TCP,只要窗口足够大,TCP也可以不受往返的约束而源源不断的传输数据

而在传输小包时,本来一个往返就能完成的,却要耗费3次握手和4次挥手,效率的确很低

### 最经典的网络问题

Wireshark性能三把虎

1. 查看平均流量速度: Statistics->Summary
2. 查看建议: Analyze->Expert Infos
3. 查看数据传输: 选中某个包,Statistics->Tcp StreamGraph->TCP Sequence Graph(Stevents),正常的传输是一条直线,中间无中断过程

纳格(Nagle)算法: 解决小包问题

```javascript
if 有新数据要发
  if 数据量超过MMS(即一个TCP包所能携带的最大数据量)
    立即发送
  else
    if 之前发出去的数据尚未确认
      把数据缓存亲来,凑够MSS或等待确认到达再发送
    else
      立即发送
    else if
  else if
else if  
```

### 为什么丢单子

Linux用户访问挂载文件夹

用户同时在20个群组

现在分别有20个群组权限的文件夹

用户只能打开前16个,而后4个不能打开

不通过挂载,而在本地文件夹设置权限,20个都可以打开

在RFC 5532 发现了gids<16>的代码,即访问挂载点要PRC层传递gids

而本地访问文件夹是不需要的

解决方式有

1. 把客户端的/etc/passwd和/etc/group复制到服务器上,但是问题是客户端修改了群组,而忘记同步到服务器时,就会有问题

### 虚惊一场

4次挥手

```
服务器 -> FIN Seq=X Ack=Y(我想断连接) -> 客户端
服务器 <- Seq=Y,Ack=X+1(知道了,断开吧) <- 客户端
服务器 <- FIN Seq=Y,Ack=X+1 (我也想断连接) <- 客户端
服务器 -> Seq=X+1,Ack=Y+1(知道了,断开吧) -> 客户端
```

延迟确认可以把4次挥手减少到3次

### Wireshark的提示






